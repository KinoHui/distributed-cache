
  > @README.md è¯·é˜…è¯»æ•´ä¸ªé¡¹ç›®ï¼ŒREADMEæ˜¯æˆ‘çš„ç®€å†å¯¹äºè¿™ä¸ªé¡¹ç›®çš„æè¿°ï¼Œè¯·é’ˆå¯¹è¿™ä¸ªé¡¹ç›®å’Œæˆ‘çš„ç®€å†ï¼Œå¸®æˆ‘ä¸ºè¿™ä¸ªé¡¹ç›®å‡†å¤‡é¢è¯•  

  âœ”  read_many_files å°†å°è¯•è¯»å–å¹¶è¿æ¥æ–‡ä»¶ ä½¿ç”¨æ¨¡å¼ï¼š`README.md`ï¼ˆç›®æ ‡ç›®å½•ï¼š`D:\GoStudy\github-clones\distributed-cache`ï¼‰ã€‚æ’é™¤ï¼šç±»ä¼¼ `**/node_modules/**`,â€¦
     ### ReadManyFiles ç»“æœï¼ˆç›®æ ‡ç›®å½•ï¼š`D:\GoStudy\github-clones\distributed-cache`ï¼‰

     æˆåŠŸè¯»å–å¹¶è¿æ¥äº† **1 ä¸ªæ–‡ä»¶** çš„å†…å®¹ã€‚

     **å·²å¤„ç†çš„æ–‡ä»¶ï¼š**
     - `README.md`

âœ¦ æˆ‘æ¥å¸®ä½ å‡†å¤‡è¿™ä¸ªåˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿé¡¹ç›®çš„é¢è¯•ã€‚é¦–å…ˆè®©æˆ‘é˜…è¯»æ•´ä¸ªé¡¹ç›®çš„ä»£ç æ¥æ·±å…¥ç†è§£å®ç°ç»†èŠ‚ã€‚

  âœ”  read_file main.go
     ä» main.go è¯»å–æ‰€æœ‰ 79 è¡Œæ•°æ®

  âœ”  read_file jincache\jincache.go
     ä» jincache/jincache.go è¯»å–æ‰€æœ‰ 135 è¡Œæ•°æ®

  âœ”  read_file jincache\cache.go
     ä» jincache/cache.go è¯»å–æ‰€æœ‰ 37 è¡Œæ•°æ®

  âœ”  read_file lru\lru.go
     ä» lru/lru.go è¯»å–æ‰€æœ‰ 81 è¡Œæ•°æ®

  âœ”  read_file ...cache\consistenthash\consistenthash.go
     ä» jincache/consistenthash/consistenthash.go è¯»å–æ‰€æœ‰ 59 è¡Œæ•°æ®

  âœ”  read_file ...jincache\singleflight\singleflight.go
     ä» jincache/singleflight/singleflight.go è¯»å–æ‰€æœ‰ 40 è¡Œæ•°æ®

  âœ”  read_file jincache\http.go
     ä» jincache/http.go è¯»å–æ‰€æœ‰ 142 è¡Œæ•°æ®

  âœ”  read_file jincache\peer.go
     ä» jincache/peer.go è¯»å–æ‰€æœ‰ 15 è¡Œæ•°æ®

  âœ”  read_file jincache\byteview.go
     ä» jincache/byteview.go è¯»å–æ‰€æœ‰ 27 è¡Œæ•°æ®

  âœ”  read_file test\cache_test.go
     ä» test/cache_test.go è¯»å–æ‰€æœ‰ 44 è¡Œæ•°æ®

âœ¦ åŸºäºä½ çš„é¡¹ç›®ä»£ç å’Œç®€å†æè¿°ï¼Œæˆ‘æ¥ä¸ºä½ å‡†å¤‡åˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿé¡¹ç›®çš„é¢è¯•é—®é¢˜å’Œç­”æ¡ˆï¼š

  ğŸ¯ æ ¸å¿ƒæŠ€æœ¯é¢è¯•é—®é¢˜

  1. LRUç¼“å­˜æ·˜æ±°ç®—æ³•
  é¢è¯•å®˜å¯èƒ½é—®ï¼š
   - è¯·è¯¦ç»†è§£é‡ŠLRUç®—æ³•çš„å®ç°åŸç†
   - ä½ çš„é¡¹ç›®ä¸­å¦‚ä½•ä¿è¯LRUçš„çº¿ç¨‹å®‰å…¨ï¼Ÿ

  ä½ çš„å›ç­”è¦ç‚¹ï¼š
   - ä½¿ç”¨åŒå‘é“¾è¡¨+å“ˆå¸Œè¡¨å®ç°ï¼Œæ—¶é—´å¤æ‚åº¦O(1)
   - é“¾è¡¨å¤´éƒ¨æ˜¯æœ€è¿‘è®¿é—®ï¼Œå°¾éƒ¨æ˜¯æœ€ä¹…æœªä½¿ç”¨
   - ç¼“å­˜æ»¡æ—¶æ·˜æ±°å°¾éƒ¨èŠ‚ç‚¹
   - åœ¨cache.goä¸­ä½¿ç”¨sync.Mutexä¿è¯å¹¶å‘å®‰å…¨

  2. ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•
  é¢è¯•å®˜å¯èƒ½é—®ï¼š
   - ä¸ºä»€ä¹ˆé€‰æ‹©ä¸€è‡´æ€§å“ˆå¸Œè€Œä¸æ˜¯æ™®é€šå“ˆå¸Œï¼Ÿ
   - è™šæ‹ŸèŠ‚ç‚¹çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

  ä½ çš„å›ç­”è¦ç‚¹ï¼š
   - è§£å†³èŠ‚ç‚¹å¢å‡æ—¶å¤§é‡æ•°æ®è¿ç§»çš„é—®é¢˜
   - ä½¿ç”¨CRC32ä½œä¸ºå“ˆå¸Œå‡½æ•°ï¼Œé»˜è®¤50ä¸ªè™šæ‹ŸèŠ‚ç‚¹
   - è™šæ‹ŸèŠ‚ç‚¹è®©æ•°æ®åˆ†å¸ƒæ›´å‡åŒ€
   - é¡ºæ—¶é’ˆæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¤§äºç­‰äºkeyå“ˆå¸Œå€¼çš„èŠ‚ç‚¹

  3. Singleflightæœºåˆ¶
  é¢è¯•å®˜å¯èƒ½é—®ï¼š
   - Singleflightå¦‚ä½•è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼Ÿ
   - å¦‚æœæŸä¸ªkeyçš„è¯·æ±‚ä¸€ç›´å¤±è´¥ä¼šæ€æ ·ï¼Ÿ

  ä½ çš„å›ç­”è¦ç‚¹ï¼š
   - ä½¿ç”¨sync.WaitGroupç¡®ä¿åŒä¸€ä¸ªkeyåªè¯·æ±‚ä¸€æ¬¡
   - å¹¶å‘è¯·æ±‚å…±äº«åŒä¸€ä¸ªç»“æœï¼Œé¿å…é‡å¤è¯·æ±‚
   - å¤±è´¥æ—¶æ‰€æœ‰å¹¶å‘è¯·æ±‚éƒ½ä¼šæ”¶åˆ°é”™è¯¯
   - åœ¨loadæ–¹æ³•ä¸­ä½¿ç”¨ï¼Œå…ˆæ£€æŸ¥è¿œç¨‹èŠ‚ç‚¹å†æœ¬åœ°è·å–

  4. åˆ†å¸ƒå¼æ¶æ„è®¾è®¡
  é¢è¯•å®˜å¯èƒ½é—®ï¼š
   - èŠ‚ç‚¹é—´å¦‚ä½•é€šä¿¡ï¼Ÿ
   - å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ

  ä½ çš„å›ç­”è¦ç‚¹ï¼š
   - HTTPåè®®é€šä¿¡ï¼Œä½¿ç”¨Protobufåºåˆ—åŒ–
   - æ¯ä¸ªèŠ‚ç‚¹æ—¢æ˜¯æœåŠ¡ç«¯åˆæ˜¯å®¢æˆ·ç«¯
   - åŸºäºGroupæ¦‚å¿µè¿›è¡Œæ•°æ®åˆ†ç»„ç®¡ç†
   - é€šè¿‡PeerPickeræ¥å£é€‰æ‹©ç›®æ ‡èŠ‚ç‚¹

  ğŸ”§ æŠ€æœ¯ç»†èŠ‚é—®é¢˜

  5. å¹¶å‘æ§åˆ¶
  é¢è¯•å®˜å¯èƒ½é—®ï¼š
   - é¡¹ç›®ä¸­å“ªäº›åœ°æ–¹éœ€è¦è€ƒè™‘å¹¶å‘å®‰å…¨ï¼Ÿ
   - å¦‚ä½•é€‰æ‹©é”çš„ç²’åº¦ï¼Ÿ

  ä½ çš„å›ç­”è¦ç‚¹ï¼š
   - cacheç»“æ„ä½“ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤LRUæ“ä½œ
   - HTTPPoolä½¿ç”¨äº’æ–¥é”ä¿æŠ¤peerså’ŒhttpGetters
   - singleflight.Groupä½¿ç”¨äº’æ–¥é”ä¿æŠ¤callæ˜ å°„
   - é€‰æ‹©ç»†ç²’åº¦é”å‡å°‘ç«äº‰

  6. å†…å­˜ç®¡ç†
  é¢è¯•å®˜å¯èƒ½é—®ï¼š
   - å¦‚ä½•æ§åˆ¶ç¼“å­˜å ç”¨çš„å†…å­˜ï¼Ÿ
   - ByteViewä¸ºä»€ä¹ˆè¦æ·±æ‹·è´ï¼Ÿ

  ä½ çš„å›ç­”è¦ç‚¹ï¼š
   - é€šè¿‡maxBytesé™åˆ¶æ€»å†…å­˜ä½¿ç”¨
   - æ¯æ¬¡æ·»åŠ æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦æ·˜æ±°
   - ByteViewæ·±æ‹·è´é˜²æ­¢å¤–éƒ¨ä¿®æ”¹å½±å“ç¼“å­˜
   - å®ç°Valueæ¥å£è®¡ç®—å ç”¨å­—èŠ‚æ•°

  ğŸš€ æ€§èƒ½ä¼˜åŒ–é—®é¢˜

  7. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
  é¢è¯•å®˜å¯èƒ½é—®ï¼š
   - é¡¹ç›®ä¸­æœ‰å“ªäº›æ€§èƒ½ä¼˜åŒ–æªæ–½ï¼Ÿ
   - å¦‚ä½•ç›‘æ§å’Œè°ƒä¼˜ï¼Ÿ

  ä½ çš„å›ç­”è¦ç‚¹ï¼š
   - LRUå‡å°‘æ•°æ®åº“è®¿é—®
   - Singleflighté¿å…é‡å¤è¯·æ±‚
   - ä¸€è‡´æ€§å“ˆå¸Œå‡å°‘æ•°æ®è¿ç§»
   - Protobufåºåˆ—åŒ–æé«˜ä¼ è¾“æ•ˆç‡
   - å¯ä»¥æ·»åŠ å‘½ä¸­ç‡ã€å“åº”æ—¶é—´ç­‰ç›‘æ§æŒ‡æ ‡

  8. æ‰©å±•æ€§è®¾è®¡
  é¢è¯•å®˜å¯èƒ½é—®ï¼š
   - å¦‚ä½•æ”¯æŒæ°´å¹³æ‰©å±•ï¼Ÿ
   - å¦‚ä½•å¤„ç†çƒ­ç‚¹æ•°æ®ï¼Ÿ

  ä½ çš„å›ç­”è¦ç‚¹ï¼š
   - åŠ¨æ€æ·»åŠ /ç§»é™¤èŠ‚ç‚¹
   - ä¸€è‡´æ€§å“ˆå¸Œè‡ªåŠ¨é‡æ–°åˆ†å¸ƒ
   - å¯ä»¥è€ƒè™‘çƒ­ç‚¹æ•°æ®æ£€æµ‹å’Œæœ¬åœ°ç¼“å­˜
   - æ”¯æŒå¤šGroupéš”ç¦»ä¸åŒä¸šåŠ¡æ•°æ®

  ğŸ“ é¡¹ç›®èŒè´£äº®ç‚¹

  å¼ºè°ƒä½ çš„è´¡çŒ®ï¼š
   1. LRUæ¨¡å—è®¾è®¡ï¼šå®ç°äº†é«˜æ•ˆçš„O(1)æ—¶é—´å¤æ‚åº¦ç¼“å­˜æ·˜æ±°
   2. å¹¶å‘ä¼˜åŒ–ï¼šé€šè¿‡ç»†ç²’åº¦é”å’ŒSingleflightæå‡å¹¶å‘æ€§èƒ½
   3. åˆ†å¸ƒå¼åè°ƒï¼šä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å®ç°èŠ‚ç‚¹åŠ¨æ€ç®¡ç†
   4. ç¨³å®šæ€§ä¿éšœï¼šå¤šå±‚å®¹é”™æœºåˆ¶ç¡®ä¿ç³»ç»Ÿé«˜å¯ç”¨

  ğŸ’¡ é¢è¯•å‡†å¤‡å»ºè®®

   1. å‡†å¤‡ç”»å›¾ï¼šèƒ½å¤Ÿç”»å‡ºç³»ç»Ÿæ¶æ„å›¾å’Œæ•°æ®æµç¨‹å›¾
   2. æ€§èƒ½æ•°æ®ï¼šå‡†å¤‡ä¸€äº›æ€§èƒ½æµ‹è¯•æ•°æ®ï¼Œå¦‚QPSã€å‘½ä¸­ç‡ç­‰
   3. æ‰©å±•æ€è·¯ï¼šæ€è€ƒå¯ä»¥å¦‚ä½•è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå¦‚æŒä¹…åŒ–ã€ç›‘æ§ç­‰
   4. å®é™…æ¡ˆä¾‹ï¼šå‡†å¤‡é¡¹ç›®ä¸­é‡åˆ°çš„å…·ä½“é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

âœ¦ è¿™ä¸ªé¡¹ç›®ä½“ç°äº†ä½ åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿã€å¹¶å‘ç¼–ç¨‹ã€ç®—æ³•è®¾è®¡ç­‰æ–¹é¢çš„èƒ½åŠ›ï¼Œæ˜¯å¾ˆå¥½çš„é¢è¯•ç´ æï¼

  > å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š1.LRUå¢ï¼ŒæŸ¥æ“ä½œå…·ä½“æµç¨‹ 2. å†·çƒ­æ•°æ®é—®é¢˜                                                     
                                                                                                              
    å†·æ•°æ®æŠŠçƒ­æ•°æ®æŒ¤èµ°æ€ä¹ˆåŠ 3.æ²¡æœ‰è¿‡æœŸæ—¶é—´å—ï¼Œæ€ä¹ˆè®¾è®¡ 4.æ”¯æŒä»€ä¹ˆæ•°æ®ç»“æ„ 5. ç¼“å­˜å¤±æ•ˆæˆ–è€…æ²¡æœ‰å‘½ä¸­è¯¥å¦‚ä½•å¤„ç†  

âœ¦ åŸºäºä½ çš„é¡¹ç›®ä»£ç ï¼Œæˆ‘æ¥è¯¦ç»†å›ç­”è¿™äº›é—®é¢˜ï¼š

  1. LRUå¢ã€æŸ¥æ“ä½œå…·ä½“æµç¨‹

  æŸ¥æ“ä½œæµç¨‹ (Get)
   1 // lru/lru.go:21-28
   2 func (c *Cache) Get(key string) (value Value, ok bool) {
   3     if ele, ok := c.cache[key]; ok {
   4         c.ll.MoveToFront(ele)  // ç§»åˆ°é“¾è¡¨å¤´éƒ¨
   5         kv := ele.Value.(*entry)
   6         return kv.value, true
   7     }
   8     return
   9 }
   1. é€šè¿‡å“ˆå¸Œè¡¨æŸ¥æ‰¾keyæ˜¯å¦å­˜åœ¨
   2. å¦‚æœå­˜åœ¨ï¼Œå°†å¯¹åº”èŠ‚ç‚¹ç§»åˆ°åŒå‘é“¾è¡¨å¤´éƒ¨
   3. è¿”å›èŠ‚ç‚¹å­˜å‚¨çš„value

  å¢æ“ä½œæµç¨‹ (Add)
    1 // lru/lru.go:45-58
    2 func (c *Cache) Add(key string, value Value) {
    3     if ele, ok := c.cache[key]; ok {
    4         // keyå·²å­˜åœ¨ï¼Œæ›´æ–°valueå¹¶ç§»åˆ°å¤´éƒ¨
    5         c.ll.MoveToFront(ele)
    6         kv := ele.Value.(*entry)
    7         c.nbytes += int64(value.Len()) - int64(kv.value.Len())
    8         kv.value = value
    9     } else {
   10         // keyä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹
   11         ele := c.ll.PushFront(&entry{key, value})
   12         c.cache[key] = ele
   13         c.nbytes += int64(len(key)) + int64(value.Len())
   14     }
   15     // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·˜æ±°
   16     for c.maxBytes != 0 && c.maxBytes < c.nbytes {
   17         c.RemoveOldest()
   18     }
   19 }

  2. å†·çƒ­æ•°æ®é—®é¢˜

  é—®é¢˜ï¼šå†·æ•°æ®è®¿é—®ä¸€æ¬¡åè¿›å…¥ç¼“å­˜ï¼Œå¯èƒ½æŠŠçƒ­æ•°æ®æŒ¤èµ°

  å½“å‰é¡¹ç›®çš„ä¸è¶³ï¼š
   - çº¯LRUç®—æ³•ç¡®å®å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œä¸€æ¬¡è®¿é—®å°±ä¼šè®©å†·æ•°æ®è¿›å…¥ç¼“å­˜

  è§£å†³æ–¹æ¡ˆï¼š
   1. LFUç®—æ³•ï¼šè®°å½•è®¿é—®é¢‘ç‡ï¼Œä¼˜å…ˆæ·˜æ±°è®¿é—®é¢‘ç‡ä½çš„æ•°æ®
   2. LRU-Kï¼šè®°å½•æœ€è¿‘Kæ¬¡è®¿é—®æ—¶é—´ï¼Œåªæœ‰è®¿é—®Kæ¬¡ä»¥ä¸Šæ‰è®¤ä¸ºæ˜¯çƒ­æ•°æ®
   3. é‡‡æ ·LRUï¼šRedisä½¿ç”¨çš„ç®—æ³•ï¼Œéšæœºé‡‡æ ·ä¸€å®šæ•°é‡çš„keyï¼Œæ·˜æ±°æœ€æ—§çš„
   4. çƒ­æ•°æ®è¯†åˆ«ï¼šå¯ä»¥æ·»åŠ è®¿é—®è®¡æ•°å™¨ï¼Œå®šæœŸæ¸…ç†ä½é¢‘æ•°æ®

  3. è¿‡æœŸæ—¶é—´è®¾è®¡

  å½“å‰é¡¹ç›®æ²¡æœ‰è¿‡æœŸæœºåˆ¶ï¼Œå¯ä»¥è¿™æ ·è®¾è®¡ï¼š

    1 type entry struct {
    2     key       string
    3     value     Value
    4     expireAt  int64  // è¿‡æœŸæ—¶é—´æˆ³
    5 }
    6 
    7 // æ·»åŠ è¿‡æœŸæ£€æŸ¥
    8 func (c *Cache) Get(key string) (value Value, ok bool) {
    9     if ele, ok := c.cache[key]; ok {
   10         kv := ele.Value.(*entry)
   11         // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
   12         if kv.expireAt > 0 && time.Now().Unix() > kv.expireAt {
   13             c.removeElement(ele)
   14             return
   15         }
   16         c.ll.MoveToFront(ele)
   17         return kv.value, true
   18     }
   19     return
   20 }
   21 
   22 // åå°å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
   23 func (c *Cache) expireCleanup() {
   24     for {
   25         time.Sleep(time.Minute)
   26         c.mu.Lock()
   27         ele := c.ll.Back()
   28         for ele != nil {
   29             kv := ele.Value.(*entry)
   30             if kv.expireAt > 0 && time.Now().Unix() > kv.expireAt {
   31                 prev := ele.Prev()
   32                 c.removeElement(ele)
   33                 ele = prev
   34             } else {
   35                 break
   36             }
   37         }
   38         c.mu.Unlock()
   39     }
   40 }

  4. æ”¯æŒçš„æ•°æ®ç»“æ„

  å½“å‰é¡¹ç›®æ”¯æŒï¼š
   - ä»»æ„å®ç°äº†Valueæ¥å£çš„æ•°æ®ç±»å‹
   - ByteViewåŒ…è£…äº†[]byteï¼Œå¯ä»¥å­˜å‚¨ä»»æ„äºŒè¿›åˆ¶æ•°æ®

   1 // jincache/byteview.go
   2 type ByteView struct {
   3     b []byte
   4 }
   5 
   6 // Valueæ¥å£
   7 type Value interface {
   8     Len() int
   9 }

  å®é™…å¯ä»¥å­˜å‚¨ï¼š
   - å­—ç¬¦ä¸²ã€JSONã€åºåˆ—åŒ–å¯¹è±¡
   - å›¾ç‰‡ã€æ–‡ä»¶ç­‰äºŒè¿›åˆ¶æ•°æ®
   - é€šè¿‡åºåˆ—åŒ–æ”¯æŒå¤æ‚æ•°æ®ç»“æ„

  5. ç¼“å­˜å¤±æ•ˆæˆ–æœªå‘½ä¸­å¤„ç†

  å¤„ç†æµç¨‹ (jincache.go:46-68)ï¼š

    1 func (g *Group) Get(key string) (ByteView, error) {
    2     if key == "" {
    3         return ByteView{}, fmt.Errorf("key is required")
    4     }
    5 
    6     // 1. å°è¯•ä»æœ¬åœ°ç¼“å­˜è·å–
    7     if v, ok := g.mainCache.get(key); ok {
    8         log.Println("[JinCache] hit")
    9         return v, nil
   10     }
   11 
   12     // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œè°ƒç”¨loadæ–¹æ³•
   13     return g.load(key)
   14 }
   15 
   16 func (g *Group) load(key string) (value ByteView, err error) {
   17     // 3. ä½¿ç”¨Singleflighté˜²æ­¢ç¼“å­˜å‡»ç©¿
   18     viewi, err := g.loader.Do(key, func() (interface{}, error) {
   19         // 4. å°è¯•ä»è¿œç¨‹èŠ‚ç‚¹è·å–
   20         if g.peers != nil {
   21             if peer, ok := g.peers.PickPeer(key); ok {
   22                 if value, err = g.getFromPeer(peer, key); err == nil {
   23                     return value, nil
   24                 }
   25             }
   26         }
   27         // 5. ä»æœ¬åœ°æ•°æ®æºè·å–
   28         return g.getLocally(key)
   29     })
   30 
   31     if err == nil {
   32         return viewi.(ByteView), nil
   33     }
   34     return
   35 }

  å¤„ç†ç­–ç•¥ï¼š
   1. ç¼“å­˜å‘½ä¸­ï¼šç›´æ¥è¿”å›ç¼“å­˜æ•°æ®
   2. ç¼“å­˜æœªå‘½ä¸­ï¼š
      - å…ˆå°è¯•ä»å…¶ä»–åˆ†å¸ƒå¼èŠ‚ç‚¹è·å–
      - å¦‚æœè¿œç¨‹èŠ‚ç‚¹ä¹Ÿæ²¡æœ‰ï¼Œä»æ•°æ®æº(æ•°æ®åº“/API)è·å–
      - è·å–æˆåŠŸåå†™å…¥ç¼“å­˜
   3. Singleflightæœºåˆ¶ï¼šé˜²æ­¢åŒä¸€keyçš„å¹¶å‘é‡å¤è¯·æ±‚
   4. é”™è¯¯å¤„ç†ï¼šè¿”å›å…·ä½“é”™è¯¯ä¿¡æ¯ï¼Œä¸å†™å…¥ç¼“å­˜

âœ¦ è¿™ä¸ªè®¾è®¡ä½“ç°äº†åˆ†å¸ƒå¼ç¼“å­˜çš„æ ¸å¿ƒæ€æƒ³ï¼šå¤šå±‚ç¼“å­˜ã€å®¹é”™æœºåˆ¶ã€æ€§èƒ½ä¼˜åŒ–ã€‚

  > æŠŠæ‰€æœ‰é—®é¢˜æ€»ç»“æˆé¢è¯•mdè¾“å‡º  


â„¹ è¯·æ±‚å·²å–æ¶ˆã€‚
 

  > å›ç­”ï¼šå¢åŠ æˆ–è€…åˆ é™¤èŠ‚ç‚¹æ—¶æ˜¯æ€ä¹ˆå¤„ç†çš„  

âœ¦ åŸºäºä½ çš„é¡¹ç›®ä»£ç ï¼Œæˆ‘æ¥è¯¦ç»†è§£é‡Šå¢åŠ æˆ–åˆ é™¤èŠ‚ç‚¹çš„å¤„ç†æœºåˆ¶ï¼š

  èŠ‚ç‚¹å˜æ›´å¤„ç†æµç¨‹

  1. å¢åŠ èŠ‚ç‚¹å¤„ç†

  ä¸€è‡´æ€§å“ˆå¸Œé‡æ–°è®¡ç®— (jincache/consistenthash/consistenthash.go:25-35)ï¼š
    1 func (m *Map) Add(keys ...string) {
    2     for _, key := range keys {
    3         // ä¸ºæ¯ä¸ªçœŸå®èŠ‚ç‚¹åˆ›å»ºå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹
    4         for i := 0; i < m.replicas; i++ {
    5             hash := int(m.hash([]byte(strconv.Itoa(i) + key)))
    6             m.keys = append(m.keys, hash)
    7             m.hashMap[hash] = key
    8         }
    9     }
   10     sort.Ints(m.keys)  // é‡æ–°æ’åºå“ˆå¸Œç¯
   11 }

  HTTPæ± èŠ‚ç‚¹æ›´æ–° (jincache/http.go:102-110)ï¼š
    1 func (p *HTTPPool) Set(peers ...string) {
    2     p.mu.Lock()
    3     defer p.mu.Unlock()
    4 
    5     // é‡æ–°åˆ›å»ºä¸€è‡´æ€§å“ˆå¸Œæ˜ å°„
    6     p.peers = consistenthash.New(defaultReplicas, nil)
    7     p.peers.Add(peers...)
    8 
    9     // ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºHTTPå®¢æˆ·ç«¯
   10     p.httpGetters = make(map[string]*httpGetter, len(peers))
   11     for _, peer := range peers {
   12         p.httpGetters[peer] = &httpGetter{baseURL: peer + p.basePath}
   13     }
   14 }

  2. åˆ é™¤èŠ‚ç‚¹å¤„ç†

  å½“å‰é¡¹ç›®çš„é™åˆ¶ï¼š
   - é¡¹ç›®ä¸­æ²¡æœ‰æ˜¾å¼çš„åˆ é™¤èŠ‚ç‚¹æ–¹æ³•
   - åˆ é™¤èŠ‚ç‚¹éœ€è¦é‡æ–°è°ƒç”¨Set()æ–¹æ³•ï¼Œä¼ å…¥æ–°çš„èŠ‚ç‚¹åˆ—è¡¨

  å®é™…å¤„ç†æ–¹å¼ï¼š
   1 // å‡è®¾åŸæœ‰èŠ‚ç‚¹ï¼š[8001, 8002, 8003]
   2 // è¦åˆ é™¤8002èŠ‚ç‚¹ï¼Œéœ€è¦ï¼š
   3 newPeers := []string{"http://localhost:8001", "http://localhost:8003"}
   4 pool.Set(newPeers...)  // é‡æ–°æ„å»ºå“ˆå¸Œç¯

  æ•°æ®è¿ç§»æœºåˆ¶

  3. æ•°æ®é‡æ–°åˆ†å¸ƒ

  èŠ‚ç‚¹å˜æ›´åçš„å½±å“ï¼š
   1. éƒ¨åˆ†æ•°æ®éœ€è¦é‡æ–°è·¯ç”±ï¼šåªæœ‰è¢«å½±å“keyçš„è¯·æ±‚ä¼šè¿ç§»åˆ°æ–°èŠ‚ç‚¹
   2. æ¸è¿›å¼è¿ç§»ï¼šä¸æ˜¯ç«‹å³å…¨é‡è¿ç§»ï¼Œè€Œæ˜¯æŒ‰éœ€è¿ç§»
   3. ç¼“å­˜é‡å»ºï¼šæ–°èŠ‚ç‚¹é¦–æ¬¡æ¥æ”¶è¯·æ±‚æ—¶ä»æ•°æ®æºé‡æ–°åŠ è½½

  å…·ä½“æµç¨‹ï¼š
    1 func (p *HTTPPool) PickPeer(key string) (PeerGetter, bool) {
    2     p.mu.Lock()
    3     defer p.mu.Unlock()
    4 
    5     // é€šè¿‡ä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹©èŠ‚ç‚¹
    6     if peer := p.peers.Get(key); peer != "" && peer != p.self {
    7         p.Log("Pick peer %s", peer)
    8         return p.httpGetters[peer], true
    9     }
   10     return nil, false
   11 }

  4. æ•°æ®ä¸€è‡´æ€§å¤„ç†

  å½“å‰é¡¹ç›®çš„ç­–ç•¥ï¼š
   - æœ€ç»ˆä¸€è‡´æ€§ï¼šä¸ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œå…è®¸çŸ­æš‚çš„æ•°æ®ä¸ä¸€è‡´
   - è¢«åŠ¨æ›´æ–°ï¼šåªæœ‰è®¿é—®æ—¶æ‰è§¦å‘æ•°æ®è¿ç§»
   - æ— ä¸»åŠ¨åŒæ­¥ï¼šèŠ‚ç‚¹é—´ä¸ä¸»åŠ¨åŒæ­¥æ•°æ®

  èŠ‚ç‚¹å˜æ›´çš„å½±å“èŒƒå›´

  5. å½±å“åˆ†æ

  å¢åŠ èŠ‚ç‚¹æ—¶ï¼š
   - å—å½±å“çš„æ•°æ®é‡ï¼šçº¦ 1/N (Nä¸ºèŠ‚ç‚¹æ€»æ•°)
   - ä¾‹å¦‚ï¼š3ä¸ªèŠ‚ç‚¹å¢åŠ åˆ°4ä¸ªèŠ‚ç‚¹ï¼Œçº¦25%çš„æ•°æ®éœ€è¦é‡æ–°è·¯ç”±

  åˆ é™¤èŠ‚ç‚¹æ—¶ï¼š
   - å—å½±å“çš„æ•°æ®é‡ï¼šçº¦ 1/N
   - è¢«åˆ é™¤èŠ‚ç‚¹çš„æ•°æ®ä¼šé‡æ–°åˆ†é…åˆ°å…¶ä»–èŠ‚ç‚¹

  6. ä¼˜åŒ–å»ºè®®

  å½“å‰é¡¹ç›®çš„ä¸è¶³å’Œæ”¹è¿›æ–¹å‘ï¼š

   1. ç¼ºå°‘å¹³æ»‘æ‰©å®¹ï¼š
   1 // å¯ä»¥æ·»åŠ å¹³æ»‘è¿ç§»æ–¹æ³•
   2 func (p *HTTPPool) AddNodeSmoothly(newNode string) {
   3     // 1. å…ˆæ·»åŠ èŠ‚ç‚¹ä½†ä¸ç«‹å³è·¯ç”±æµé‡
   4     // 2. åå°é€æ­¥è¿ç§»çƒ­ç‚¹æ•°æ®
   5     // 3. å®Œæˆåæ­£å¼åŠ å…¥è·¯ç”±
   6 }

   2. ç¼ºå°‘èŠ‚ç‚¹å¥åº·æ£€æŸ¥ï¼š
   1 // æ·»åŠ èŠ‚ç‚¹å¥åº·çŠ¶æ€ç›‘æ§
   2 func (p *HTTPPool) HealthCheck() {
   3     for peer, getter := range p.httpGetters {
   4         if !isHealthy(peer) {
   5             // ä¸´æ—¶ç§»é™¤ä¸å¥åº·èŠ‚ç‚¹
   6             p.removeUnhealthyPeer(peer)
   7         }
   8     }
   9 }

   3. æ•°æ®é¢„çƒ­æœºåˆ¶ï¼š
   1 // æ–°èŠ‚ç‚¹åŠ å…¥æ—¶é¢„çƒ­çƒ­ç‚¹æ•°æ®
   2 func (p *HTTPPool) WarmupNewNode(newNode string) {
   3     // è¯†åˆ«çƒ­ç‚¹key
   4     // ä¸»åŠ¨æ¨é€åˆ°æ–°èŠ‚ç‚¹
   5 }

  æ€»ç»“

  ä½ çš„é¡¹ç›®åœ¨èŠ‚ç‚¹å¤„ç†æ–¹é¢ï¼š
   - âœ… ä¼˜ç‚¹ï¼šä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œå‡å°‘æ•°æ®è¿ç§»é‡
   - âœ… ä¼˜ç‚¹ï¼šè™šæ‹ŸèŠ‚ç‚¹ä¿è¯æ•°æ®åˆ†å¸ƒå‡åŒ€
   - âš ï¸ ä¸è¶³ï¼šç¼ºå°‘å¹³æ»‘æ‰©å®¹æœºåˆ¶
   - âš ï¸ ä¸è¶³ï¼šæ²¡æœ‰èŠ‚ç‚¹å¥åº·æ£€æŸ¥
   - âš ï¸ ä¸è¶³ï¼šç¼ºå°‘æ•°æ®é¢„çƒ­å’Œä¸»åŠ¨åŒæ­¥

âœ¦ è¿™ç§è®¾è®¡é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œåœ¨é¢è¯•æ—¶å¯ä»¥æå‡ºè¿™äº›ä¼˜åŒ–æ€è·¯æ¥å±•ç¤ºä½ çš„æ·±å…¥æ€è€ƒã€‚

  > å›ç­”ï¼šæŒä¹…åŒ–æœ‰æ²¡æœ‰è®¾è®¡  

âœ¦ åŸºäºä½ çš„é¡¹ç›®ä»£ç åˆ†æï¼š

  å½“å‰é¡¹ç›®çš„æŒä¹…åŒ–çŠ¶å†µ

  æ²¡æœ‰æŒä¹…åŒ–è®¾è®¡ï¼Œè¿™æ˜¯ä¸€ä¸ªçº¯å†…å­˜ç¼“å­˜ç³»ç»Ÿã€‚

  ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼š
   - æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨å†…å­˜ä¸­çš„LRUç¼“å­˜é‡Œ
   - æ•°æ®æ¥æºæ˜¯é€šè¿‡Getteræ¥å£ä»å¤–éƒ¨æ•°æ®æºè·å–
   - èŠ‚ç‚¹é‡å¯åç¼“å­˜æ•°æ®ä¼šä¸¢å¤±ï¼Œéœ€è¦é‡æ–°ä»æ•°æ®æºåŠ è½½

  ä¸ºä»€ä¹ˆæ²¡æœ‰æŒä¹…åŒ–

  é¡¹ç›®å®šä½ï¼š
   1 // main.goä¸­çš„æ•°æ®åº“æ¨¡æ‹Ÿ
   2 var db = map[string]string{
   3     "Tom":  "630",
   4     "Jack": "589",
   5     "Sam":  "567",
   6 }

  è¿™æ˜¯ä¸€ä¸ªç¼“å­˜å±‚ï¼Œä¸æ˜¯å­˜å‚¨å±‚ï¼š
   - ç¼“å­˜çš„ä½œç”¨æ˜¯åŠ é€Ÿè®¿é—®ï¼Œå‡å°‘åç«¯å‹åŠ›
   - æ•°æ®æŒä¹…åŒ–ç”±åç«¯æ•°æ®åº“è´Ÿè´£
   - ç¼“å­˜ä¸¢å¤±ä¸ä¼šå½±å“æ•°æ®å®Œæ•´æ€§

  å¦‚æœè¦è®¾è®¡æŒä¹…åŒ–

  1. æŒä¹…åŒ–ç­–ç•¥é€‰æ‹©

  RDB (å¿«ç…§æ–¹å¼)ï¼š
    1 type RDBPersistence struct {
    2     filePath string
    3     interval time.Duration
    4 }
    5 
    6 func (p *RDBPersistence) SaveSnapshot(cache *Cache) error {
    7     data := make(map[string][]byte)
    8     // éå†LRUç¼“å­˜ï¼Œåºåˆ—åŒ–æ•°æ®
    9     for key, value := range cache.cache {
   10         kv := value.Value.(*entry)
   11         data[key] = kv.value.([]byte)
   12     }
   13 
   14     // å†™å…¥æ–‡ä»¶
   15     file, err := os.Create(p.filePath)
   16     if err != nil {
   17         return err
   18     }
   19     defer file.Close()
   20 
   21     return json.NewEncoder(file).Encode(data)
   22 }

  AOF (æ—¥å¿—æ–¹å¼)ï¼š
    1 type AOFPersistence struct {
    2     file *os.File
    3     mu   sync.Mutex
    4 }
    5 
    6 func (p *AOFPersistence) AppendLog(operation string, key string, value []byte) {
    7     p.mu.Lock()
    8     defer p.mu.Unlock()
    9 
   10     log := fmt.Sprintf("%s %s %s\n", operation, key, string(value))
   11     p.file.WriteString(log)
   12     p.file.Sync()  // å¼ºåˆ¶åˆ·ç›˜
   13 }

  2. æŒä¹…åŒ–æ—¶æœº

  å®šæ—¶æŒä¹…åŒ–ï¼š
   1 func (c *Cache) startPersistence() {
   2     ticker := time.NewTicker(5 * time.Minute)
   3     go func() {
   4         for range ticker.C {
   5             c.saveToFile()
   6         }
   7     }()
   8 }

  å¢é‡æŒä¹…åŒ–ï¼š
   1 func (c *Cache) Add(key string, value Value) {
   2     // åŸæœ‰é€»è¾‘...
   3 
   4     // è®°å½•æ“ä½œæ—¥å¿—
   5     if c.persistence != nil {
   6         c.persistence.AppendLog("ADD", key, value.([]byte))
   7     }
   8 }

  3. æ¢å¤æœºåˆ¶

  å¯åŠ¨æ—¶æ¢å¤ï¼š
    1 func (c *Cache) LoadFromFile() error {
    2     file, err := os.Open(c.persistenceFile)
    3     if err != nil {
    4         return err
    5     }
    6     defer file.Close()
    7 
    8     var data map[string][]byte
    9     if err := json.NewDecoder(file).Decode(&data); err != nil {
   10         return err
   11     }
   12 
   13     // é‡å»ºç¼“å­˜
   14     for key, value := range data {
   15         c.Add(key, ByteView{b: value})
   16     }
   17     return nil
   18 }

  4. åˆ†å¸ƒå¼æŒä¹…åŒ–æŒ‘æˆ˜

  æ•°æ®ä¸€è‡´æ€§ï¼š
   - å¤šä¸ªèŠ‚ç‚¹çš„æŒä¹…åŒ–æ•°æ®å¯èƒ½ä¸ä¸€è‡´
   - éœ€è¦åè°ƒæœºåˆ¶ä¿è¯ä¸€è‡´æ€§

  æ€§èƒ½å½±å“ï¼š
   - æŒä¹…åŒ–æ“ä½œä¼šå½±å“ç¼“å­˜æ€§èƒ½
   - éœ€è¦å¼‚æ­¥å¤„ç†é¿å…é˜»å¡

  æŒä¹…åŒ–è®¾è®¡å»ºè®®

  5. æ··åˆç­–ç•¥

  çƒ­ç‚¹æ•°æ®æŒä¹…åŒ–ï¼š
   1 type HotDataPersistence struct {
   2     accessCount map[string]int64
   3     threshold   int64
   4 }
   5 
   6 func (p *HotDataPersistence) ShouldPersist(key string) bool {
   7     return p.accessCount[key] > p.threshold
   8 }

  åˆ†çº§å­˜å‚¨ï¼š
   - çƒ­æ•°æ®ï¼šå†…å­˜ + SSD
   - æ¸©æ•°æ®ï¼šä»…å†…å­˜
   - å†·æ•°æ®ï¼šç£ç›˜

  6. ä¸ç°æœ‰æ¶æ„é›†æˆ

  ä¿®æ”¹Groupç»“æ„ï¼š
   1 type Group struct {
   2     name        string
   3     getter      Getter
   4     mainCache   cache
   5     peers       PeerPicker
   6     loader      *singleflight.Group
   7     persistence Persistence  // æ–°å¢æŒä¹…åŒ–æ¥å£
   8 }

  æ€»ç»“

  å½“å‰é¡¹ç›®é€‰æ‹©ä¸æŒä¹…åŒ–çš„åŸå› ï¼š
   1. å®šä½æ¸…æ™°ï¼šä½œä¸ºç¼“å­˜å±‚ï¼Œä¸æ˜¯å­˜å‚¨å±‚
   2. ç®€åŒ–è®¾è®¡ï¼šä¸“æ³¨äºç¼“å­˜æ ¸å¿ƒåŠŸèƒ½
   3. æ€§èƒ½ä¼˜å…ˆï¼šé¿å…æŒä¹…åŒ–å¸¦æ¥çš„æ€§èƒ½å¼€é”€

  é¢è¯•æ—¶å¯ä»¥è®¨è®ºï¼š
   - ä»€ä¹ˆæ—¶å€™éœ€è¦æŒä¹…åŒ–ï¼Ÿ
   - ä¸åŒæŒä¹…åŒ–ç­–ç•¥çš„ä¼˜ç¼ºç‚¹
   - åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æŒä¹…åŒ–çš„æŒ‘æˆ˜
   - å¦‚ä½•å¹³è¡¡æ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§

âœ¦ è¿™ä¸ªè®¾è®¡é€‰æ‹©ä½“ç°äº†å¯¹ç¼“å­˜ç³»ç»Ÿæœ¬è´¨çš„ç†è§£ï¼Œåœ¨é¢è¯•ä¸­å¯ä»¥å¼ºè°ƒè¿™ç§æ¶æ„è®¾è®¡çš„åˆç†æ€§ã€‚

  > æŠŠåˆšæ‰çš„æ‰€æœ‰å¯¹è¯æ€»ç»“æˆé¢è¯•mdè¾“å‡º  

  âœ”  write_file æ­£åœ¨å†™å…¥ åˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿé¢è¯•æŒ‡å—.md
     ... å‰ 385 è¡Œå·²éšè— ...ï¼ˆè¾“å…¥ctrl+ræŸ¥çœ‹å…¨éƒ¨ï¼‰
     386 
     387 è¿™ä¸ªåˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿé¡¹ç›®ä½“ç°äº†ï¼š
     388 - **æ‰å®çš„ç®—æ³•åŸºç¡€**ï¼šLRUã€ä¸€è‡´æ€§å“ˆå¸Œ
     389 - **å¹¶å‘ç¼–ç¨‹èƒ½åŠ›**ï¼šé”æœºåˆ¶ã€Singleflight
     390 - **åˆ†å¸ƒå¼ç³»ç»Ÿç†è§£**ï¼šèŠ‚ç‚¹ç®¡ç†ã€æ•°æ®è·¯ç”±
     391 - **æ€§èƒ½ä¼˜åŒ–æ„è¯†**ï¼šç¼“å­˜ç­–ç•¥ã€é€šä¿¡ä¼˜åŒ–
     392 - **å·¥ç¨‹å®è·µèƒ½åŠ›**ï¼šæ¨¡å—åŒ–è®¾è®¡ã€æ¥å£æŠ½è±¡
     393 
     394 åœ¨é¢è¯•ä¸­è¦çªå‡ºæŠ€æœ¯æ·±åº¦ã€æ¶æ„æ€ç»´å’Œè§£å†³é—®é¢˜çš„èƒ½åŠ›ï¼Œå±•ç°å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ·±å…¥ç†è§£ã€‚

âœ¦ å·²ä¸ºä½ åˆ›å»ºäº†å®Œæ•´çš„é¢è¯•æŒ‡å—æ–‡æ¡£ åˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿé¢è¯•æŒ‡å—.mdï¼ŒåŒ…å«äº†æˆ‘ä»¬è®¨è®ºçš„æ‰€æœ‰æŠ€æœ¯ç‚¹å’Œé¢è¯•å‡†å¤‡å»ºè®®ã€‚

  æ–‡æ¡£æ¶µç›–äº†ï¼š
   - é¡¹ç›®æ¶æ„å’Œæ ¸å¿ƒæŠ€æœ¯
   - è¯¦ç»†çš„ç®—æ³•å®ç°æµç¨‹
   - åˆ†å¸ƒå¼èŠ‚ç‚¹ç®¡ç†æœºåˆ¶
   - æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
   - å¯èƒ½çš„é¢è¯•é—®é¢˜å’Œç­”æ¡ˆè¦ç‚¹

âœ¦ è¿™ä»½æ–‡æ¡£å¯ä»¥ä½œä¸ºä½ é¢è¯•å‡†å¤‡çš„å‚è€ƒèµ„æ–™ï¼Œé‡ç‚¹çªå‡ºä½ åœ¨LRUç¼“å­˜ã€ä¸€è‡´æ€§å“ˆå¸Œã€Singleflightæœºåˆ¶ç­‰æ–¹é¢çš„æŠ€æœ¯è´¡çŒ®ã€‚

  > /export file  


                                                                                               æ€è€ƒ:å…³é—­ (tabåˆ‡æ¢) æ™ºèƒ½æ¨¡å¼ (shift + tab / alt + m åˆ‡æ¢)
D:\GoStudy\github-clones\distributed-cache (main*)                                         glm-4.6 ä¸Šä¸‹æ–‡å‰©ä½™ 86% | â—¯ åˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿé¢è¯•æŒ‡å—.md | v0.4.7
