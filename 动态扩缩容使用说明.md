# 动态扩缩容和数据迁移使用说明

## 环境准备

### 1. 启动etcd服务
确保etcd服务运行在 `192.168.59.132:2379`，或修改启动参数中的etcd地址。

### 2. 安装依赖
```bash
go mod tidy
```

## 启动缓存节点

### 启动第一个节点
```bash
go run main.go -port=8001
```

### 启动第二个节点  
```bash
go run main.go -port=8002
```

### 启动第三个节点
```bash
go run main.go -port=8003
```

### 启动API服务器
```bash
go run main.go -port=8001 -api=true
```

## 功能特性

### 1. 动态节点注册
- 节点启动时自动向etcd注册
- 节点信息包括：ID、地址、状态、最后心跳时间
- 支持优雅关闭，自动注销服务

### 2. 节点发现和监听
- 实时监听etcd中的节点变化
- 自动更新本地一致性哈希环
- 节点故障时自动从哈希环中移除

### 3. 数据迁移
- 节点加入/离开时自动触发数据迁移
- 支持批量迁移，避免阻塞主流程
- 迁移完成后进行数据验证

### 4. 心跳机制
- 30秒TTL租约，自动续约
- 10秒间隔更新心跳时间
- 节点故障时租约自动过期

## 测试动态扩缩容

### 扩容测试
1. 启动2个节点（8001, 8002）
2. 观察节点注册成功
3. 启动第3个节点（8003）
4. 观察数据自动迁移

### 缩容测试
1. 启动3个节点
2. 优雅关闭其中一个节点（Ctrl+C）
3. 观察其他节点自动检测到故障
4. 观察数据重新分布

## API测试

### 缓存查询
```bash
curl "http://localhost:9999/api?key=Tom"
```

### 查看etcd中的节点信息
```bash
etcdctl get --prefix /jincache/nodes/
```

## 监控和日志

### 关键日志
- `[Discovery]` - 服务发现相关日志
- `[Migration]` - 数据迁移相关日志  
- `[HTTPPool]` - 节点管理相关日志
- `[Main]` - 主程序相关日志

### 监控指标
- 节点注册/注销事件
- 数据迁移进度
- 心跳续约状态
- 节点健康状态

## 故障处理

### etcd连接失败
- 检查etcd服务是否正常运行
- 验证网络连接和端口配置
- 查看防火墙设置

### 数据迁移失败
- 检查目标节点是否可达
- 验证数据格式是否正确
- 查看迁移日志了解具体错误

### 节点无法注册
- 检查etcd连接状态
- 验证节点ID是否唯一
- 查看权限配置

## 配置参数

### 启动参数
- `-port`: 缓存服务端口（默认8001）
- `-api`: 是否启动API服务器（默认false）
- `-etcd`: etcd端点地址（默认192.168.59.132:2379）

### 内部配置
- 租约TTL: 30秒
- 心跳间隔: 10秒
- 迁移批次大小: 100
- 迁移超时: 30秒
- 虚拟节点数: 50

## 注意事项

1. **节点ID唯一性**: 每个节点必须有唯一的ID（基于端口号生成）
2. **网络连通性**: 确保所有节点之间网络互通
3. **etcd高可用**: 生产环境建议部署etcd集群
4. **数据一致性**: 迁移过程中可能出现短暂的数据不一致
5. **资源监控**: 数据迁移会消耗网络和CPU资源

## 扩展建议

1. **添加监控指标**: 集成Prometheus监控
2. **配置管理**: 支持配置文件和环境变量
3. **安全认证**: 添加etcd认证和TLS
4. **负载均衡**: 实现更智能的负载均衡策略
5. **数据压缩**: 迁移时对数据进行压缩