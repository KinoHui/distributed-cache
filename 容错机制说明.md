# 节点间通信容错机制说明

## 概述

本文档描述了分布式缓存系统中实现的节点间通信容错机制，基于方案一实现，包含超时控制、重试机制、故障节点管理和降级策略。

## 实现的功能

### 1. 超时控制

**位置**: `jincache/http.go` - `httpGetter` 结构体

**实现**:
- 为每个HTTP请求设置3秒超时
- 使用带超时的HTTP客户端：`http.Client{Timeout: 3 * time.Second}`
- 防止长时间阻塞导致服务不可用

**配置**:
```go
requestTimeout: 3 * time.Second  // 3秒超时
```

### 2. 重试机制（带指数退避）

**位置**: `jincache/http.go` - `httpGetter.Get()` 方法

**实现**:
- 最多重试2次（共3次尝试）
- 使用指数退避策略：100ms, 200ms, 400ms...
- 每次重试前等待时间：`time.Duration(1<<uint(attempt-1)) * 100 * time.Millisecond`

**重试条件**:
- 网络错误
- 服务器返回非200状态码
- 响应读取失败
- 数据解码失败

**配置**:
```go
maxRetries: 2  // 最多重试2次
```

### 3. 故障节点管理和黑名单

**位置**: `jincache/http.go` - `nodeHealth` 结构体

**实现**:

#### 3.1 失败计数
- 记录每个节点的失败次数
- 记录最后失败时间

#### 3.2 黑名单机制
- 节点失败3次后加入黑名单
- 黑名单TTL为5分钟
- 5分钟后自动从黑名单移除并重置失败计数

#### 3.3 节点选择优化
- `PickPeer` 方法在选择节点时检查黑名单
- 如果选中的节点在黑名单中，尝试选择其他健康节点
- 如果没有可用健康节点，返回nil触发降级

**配置**:
```go
nodeHealth: newNodeHealth(3, 5*time.Minute)
// 3次失败后加入黑名单，5分钟后恢复
```

#### 3.4 黑名单清理
- 启动后台协程每分钟清理过期黑名单项
- 定期检查并移除过期的黑名单记录

**方法**:
```go
cleanupBlacklistRoutine()  // 定期清理协程
cleanupBlacklist()         // 清理过期项
```

### 4. 降级策略

**位置**: `jincache/jincache.go` - `Group.getFromPeer()` 方法

**实现**:
- 当节点请求失败时，自动降级到本地数据源
- 确保服务可用性，即使部分节点故障
- 降级后从本地数据源加载数据并存入本地缓存

**降级条件**:
- 所有重试都失败
- 节点在黑名单中且无其他可用节点

**代码**:
```go
func (g *Group) getFromPeer(peer PeerGetter, key string) (ByteView, error) {
    req := &pb.Request{
        Group: g.name,
        Key:   key,
    }
    res := &pb.Response{}
    err := peer.Get(req, res)
    if err != nil {
        log.Printf("[JinCache] Failed to get from peer, falling back to local: %v", err)
        // 降级到本地数据源
        return g.getLocally(key)
    }
    return ByteView{b: res.Value}, nil
}
```

## 工作流程

### 正常流程

```
1. 客户端请求key
   ↓
2. Group.Get() 判断路由
   ↓
3. PickPeer() 选择节点（检查黑名单）
   ↓
4. httpGetter.Get() 发起HTTP请求
   ├─→ 成功：返回数据，记录节点成功
   └─→ 失败：重试
```

### 故障流程

```
1. 节点请求失败
   ↓
2. 重试（最多2次，带指数退避）
   ├─→ 重试成功：返回数据，记录节点成功
   └─→ 重试失败：
       ↓
3. 记录节点失败
   ├─→ 失败次数 < 3：继续尝试
   └─→ 失败次数 >= 3：加入黑名单
       ↓
4. 降级到本地数据源
   ↓
5. 返回数据给客户端
```

### 节点恢复流程

```
1. 节点在黑名单中
   ↓
2. 5分钟TTL到期
   ↓
3. cleanupBlacklistRoutine() 清理黑名单
   ↓
4. 节点恢复正常，可以再次被选择
   ↓
5. 首次成功后重置失败计数
```

## 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| requestTimeout | 3秒 | HTTP请求超时时间 |
| maxRetries | 2 | 最大重试次数 |
| maxFailures | 3 | 加入黑名单的失败次数阈值 |
| blacklistTTL | 5分钟 | 黑名单过期时间 |

## 日志输出

### 请求日志
```
[httpGetter] Making request to: http://localhost:8002/_jincache/scores/Tom (attempt 1)
[httpGetter] Response status: 200 OK
[httpGetter] Successfully got value for key: Tom
```

### 重试日志
```
[httpGetter] Retry attempt 1 after 100ms
[httpGetter] Making request to: http://localhost:8002/_jincache/scores/Tom (attempt 2)
```

### 失败日志
```
[httpGetter] Request failed: dial tcp 127.0.0.1:8002: connect: connection refused
[JinCache] Failed to get from peer, falling back to local: dial tcp 127.0.0.1:8002: connect: connection refused
```

### 黑名单日志
```
[NodeHealth] Node http://localhost:8002 added to blacklist (failures: 3)
[HTTPPool] Node http://localhost:8002 is blacklisted, skipping
[HTTPPool] Picking alternative peer http://localhost:8003 instead of blacklisted http://localhost:8002
```

### 恢复日志
```
[NodeHealth] Node http://localhost:8002 removed from blacklist
[NodeHealth] Node http://localhost:8002 recovered, resetting failure count
```

## 优势

1. **高可用性**: 节点故障时自动降级，保证服务可用
2. **自动恢复**: 黑名单机制避免重复失败，自动恢复
3. **性能优化**: 超时控制避免长时间等待
4. **容错增强**: 重试机制提高成功率
5. **智能路由**: 优先选择健康节点

## 注意事项

1. **降级策略**会从本地数据源加载数据，可能增加数据源负载
2. **黑名单TTL**需要根据实际情况调整，太短可能导致频繁重试，太长可能导致节点恢复延迟
3. **重试次数**不宜过多，避免影响响应时间
4. **超时时间**需要根据网络环境调整

## 测试建议

1. **节点故障测试**: 停止一个节点，观察降级行为
2. **网络延迟测试**: 模拟网络延迟，观察超时和重试
3. **节点恢复测试**: 重启故障节点，观察黑名单清理和恢复
4. **并发测试**: 高并发场景下验证容错机制的稳定性

## 未来扩展

如果需要更强的容错能力，可以考虑：

1. **熔断机制**: 使用熔断器模式，失败率达到阈值时熔断
2. **健康检查**: 定期ping节点，主动发现故障节点
3. **负载均衡**: 多个副本时选择健康节点
4. **限流保护**: 防止降级时数据源过载